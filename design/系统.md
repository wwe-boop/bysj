# 系统.md（详细版）

本文件详细说明“基于DRL的LEO卫星网络实时准入控制 + DSROQ资源分配 + Hypatia仿真”的系统实现方案。

## 1. 目标与约束
- 实时准入决策（每到达一个新流量进行一次决策）
- 兼顾QoE最大化、公平性与网络效率
- 与Hypatia无缝集成，保证可复现性与高保真

## 2. 目录结构（最终）
```
LEO-QoE-AdmissionControl/
├── docs/                     # 论文文档与API
├── design/                   # 设计文档（本目录）
│   ├── system_architecture.md
│   ├── algorithm_design.md
│   ├── experiment_design.md
│   └── 系统.md
├── src/
│   ├── admission/
│   ├── dsroq/
│   ├── hypatia/
│   ├── positioning/
│   ├── simulation/
│   ├── baselines/
│   ├── visualization/
│   ├── api/
│   ├── ui/
│   └── utils/
├── experiments/
├── data/
├── reference/
├── deploy/
└── tests/
```

注：以上为概念性结构。实际仓库命名对齐如下（示例）：
- 准入控制：`src/admission/env.py`、`src/admission/drl_admission.py`、`src/admission/threshold_admission.py`、`src/admission/positioning_aware_admission.py`
- DSROQ：`src/dsroq/mcts_routing.py`、`src/dsroq/lyapunov_optimizer.py`、`src/dsroq/bandwidth_allocator.py`
- Hypatia集成：`src/hypatia/hypatia_adapter.py`、`src/hypatia/constellation.py`、`src/hypatia/network_state.py`
- 仿真：`src/simulation/simulation_engine.py`、`src/simulation/scenario_manager.py`、`src/simulation/event_scheduler.py`、`src/simulation/traffic_generator.py`、`src/simulation/performance_monitor.py`
- 前后端：最小后端 `src/api/main.py`；完整后端位于 `web/backend`（Blueprints），前端位于 `web/frontend`

## 3. 模块详细设计

### 3.1 admission（DRL准入控制）
- 角色：基于状态做“是否/如何接纳”的策略性决策
- 状态：时间感知特征（拓扑、负载、QoE/QoS、趋势/预测、定位质量）
- 动作：五类（接受/拒绝/降级/延迟/部分），支持参数化扩展
- 奖励：QoE变化 + 公平性 + 违规惩罚 + 效率 + 稳定性
- 接口：`decide(flow_request, network_state) -> action`
实现参考：`src/admission/env.py`、`src/admission/drl_admission.py`、`src/admission/threshold_admission.py`

数据流：
- env.reset() → 从Hypatia初始化状态
- env.step(action) → 调用DSROQ/模拟器执行 → 返回新状态/奖励/信息

### 3.2 dsroq（资源分配与调度）
- MCTS路由：在动态拓扑上搜索可行/优路径（时间敏感）
- 带宽分配：路径瓶颈/比例分配/类型加权等策略
- 李雅普诺夫：队列稳定性与惩罚项优化，同步仿真步
- Hypatia适配：将路由与分配结果映射到仿真执行
实现参考：`src/dsroq/mcts_routing.py`、`src/dsroq/bandwidth_allocator.py`、`src/dsroq/lyapunov_optimizer.py`、`src/hypatia/hypatia_adapter.py`

### 3.3 simulation（仿真封装）
- 星座/场景：载入/生成星座与地面站，场景编排
- 流量：泊松/突发/周期/混合流量产生器
- 调度：事件调度与仿真时间推进，性能监控
- 状态：统一网络状态结构（便于指标与图表）
实现参考：`src/simulation/simulation_engine.py`、`src/simulation/scenario_manager.py`、`src/simulation/event_scheduler.py`、`src/simulation/traffic_generator.py`、`src/simulation/performance_monitor.py`、`src/hypatia/network_state.py`

### 3.4 baselines（基线方法）
- threshold_admission.py / load_based_admission.py / bandwidth_reservation.py
- ml_admission.py（RF/SVM/NN）/ dqn.py / a3c.py / ddpg.py / no_admission.py
- 统一接口：decide(flow_request, network_state) → action

### 3.5 visualization（可视化）
- drl_visualizer.py：DRL训练曲线、策略可视化
- qoe_heatmap.py：全球QoE热力图（按地理网格/业务类型）
- admission_stats.py：准入/拒绝/降级时序统计
- cesium_extension.py：与satviz联动显示决策点与网络拓扑动画

### 3.6 api（Web服务）
- 最小后端（演示/验证）：`src/api/main.py` 暴露准入/定位/统计等基础接口
- 完整后端（生产形态）：`web/backend` 基于 Flask Blueprints 拆分模块路由（`/api/simulation|network|admission|positioning|statistics|scenarios`）
- 与前端：`web/frontend` Vue 应用通过统一前缀 `/api/*` 调用后端
说明：两种形态可并存；最小后端便于快速验证，完整后端便于扩展与维护

### 3.7 utils（工具）
### 3.8 positioning（定位与协作定位）
- 指标：CRLB/GDOP、可见波束数、协作卫星数、平均/最小SINR、定位可用性
- 提示：Beam Hint（波束/协作卫星推荐），供资源分配与前端联动
- 接口：`metrics(t, users)`、`beam_schedule_hint(payload)`
实现参考：`src/positioning/metrics.py`、`src/positioning/beam_hint.py`、`src/positioning/crlb_calculator.py`、`src/positioning/gdop_calculator.py`、`src/positioning/positioning_calculator.py`、`src/positioning/cooperative_positioning.py`

方法与实现要点（协作定位，需与调度联合）：
- 单点定位质量评估：
  - 使用几何精度因子（GDOP/PDOP/HDOP/VDOP）与克拉美罗下界（CRLB）评估在当前卫星-用户几何构型与信噪比条件下的理论定位误差下界；
  - 基于可见卫星/波束集合，构建测量雅可比/费舍尔信息矩阵（FIM），计算 CRLB；同时统计 `visible_beams_count`、`cooperative_sat_count`、`avg_sinr/min_sinr` 等；
  - 产出 `pos_quality` 归一化指标（如 0–1），作为 DRL 状态的一部分并用于可视化。
- 协作定位融合策略：
  - 在多卫星/多波束场景下，融合 TOA/TDOA/AOA 等测量（依据 `reference/协作定位.pdf` 的融合模型），采用加权最小二乘/贝叶斯融合近似最优解；
  - 受链路/预算约束时，优先选择贡献最大的信息源（提升 FIM 行列式/降低 GDOP/CRLB）。
- 波束调度提示（Beam Hint）：
  - 给定时间 `t`、用户集合与预算（并发束数/功率/时隙），输出每用户的推荐波束/协作卫星集合；
  - 目标：在 QoS 约束下最小化群体 CRLB 或 GDOP；启发式：贪心提升 FIM、覆盖-信噪-几何三因子打分，或采用简化的上界优化；
  - 输出供 DSROQ 的路径/带宽分配、以及前端 Cesium 图层展示联动。
- 与 DRL/DSROQ 的协同策略：
  - 状态注入：`pos_quality`、`visible_beams_count`、`cooperative_sat_count`、`beam_hint_score`；
  - 策略联动：定位质量退化时触发保守/延迟接纳或优先级降级；定位需求高的业务在资源紧张时优先保障；
  - 资源重分配：当 `beam_hint` 有显著提升空间时触发 DSROQ 重分配，兼顾路由可达与定位可用性。

参考与对齐：
- 调度/联合优化方法：`reference/调度算法.pdf`
- 协作定位方法与融合模型：`reference/协作定位.pdf`
- 与论文章节对齐：`docs/03_system_design.md` 的“定位协同与特征注入（新增）”与 `docs/07_system_impl.md` 的“定位API示例”。
- logger.py：结构化日志
- metrics.py：指标聚合、统计显著性分析
- config.py：YAML配置加载与校验
- hypatia_utils.py：Hypatia数据结构转化与缓存

## 4. 关键接口与数据结构

### 4.1 FlowRequest（流量请求）
```python
@dataclass
class FlowRequest:
    id: str
    type: Literal['EF','AF','BE']
    min_bandwidth: float
    max_bandwidth: float
    max_latency: float
    src: Tuple[float, float]  # (lat, lon)
    dst: Tuple[float, float]
    expected_duration: float
    arrival_time: float
```

### 4.2 Env.step返回信息
```python
obs: np.ndarray
reward: float
done: bool
info: dict = {
  'action_type': 'ACCEPT' | 'REJECT' | 'DEGRADED_ACCEPT' | 'DELAYED_ACCEPT' | 'PARTIAL_ACCEPT',
  'current_qoe': float,
  'admission_stats': {...},
  'network_utilization': float
}
```

## 5. 实施路线（建议）
1. 打通Hypatia satgenpy → 取网络状态（星座/拓扑/链路）
2. 实现simulation.hypatia_wrapper与admission.hypatia_interface
3. 先实现二分类动作（接受/拒绝）的PPO baseline（当前演示后端 `src/api/main.py` 已采用最小可行二分类决策）
4. 接入DSROQ进行资源分配闭环
5. 扩展动作到5类 + 完整奖励函数
6. 完成基线方法与对比实验
7. 集成satviz与前端

## 6. 风险与规避
- Hypatia/NS3环境较重：建议Docker化，提供最小复现实例
- 状态维过大导致训练不稳定：先做特征选择+归一化
- 奖励延迟：采用窗口化评估、加速仿真回放
- 路由搜索复杂：限制搜索深度+启发式剪枝

## 7. 里程碑
- M1：Hypatia状态→PPO二分类→可运行demo
- M2：接入DSROQ→闭环联调→小规模实验
- M3：基线对比+消融→大规模场景（Starlink/Kuiper）
- M4：前端+satviz联动→论文撰写交付
