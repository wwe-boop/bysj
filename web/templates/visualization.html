{% extends "base.html" %}

{% block title %}可视化 - LEO卫星网络仿真系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-chart-line"></i> 系统可视化</h2>
        <hr>
    </div>
</div>

<!-- 可视化控制面板 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-sliders-h"></i> 可视化控制</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label for="chart-type" class="form-label">图表类型</label>
                        <select class="form-select" id="chart-type" onchange="changeChartType()">
                            <option value="performance">性能指标</option>
                            <option value="network">网络状态</option>
                            <option value="admission">准入控制</option>
                            <option value="positioning">定位质量</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="time-range" class="form-label">时间范围</label>
                        <select class="form-select" id="time-range" onchange="changeTimeRange()">
                            <option value="60">最近1分钟</option>
                            <option value="300">最近5分钟</option>
                            <option value="900">最近15分钟</option>
                            <option value="1800">最近30分钟</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="update-interval" class="form-label">更新间隔</label>
                        <select class="form-select" id="update-interval" onchange="changeUpdateInterval()">
                            <option value="1000">1秒</option>
                            <option value="5000" selected>5秒</option>
                            <option value="10000">10秒</option>
                            <option value="30000">30秒</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button class="btn btn-primary me-2" onclick="refreshCharts()">
                            <i class="fas fa-sync-alt"></i> 刷新
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            <i class="fas fa-download"></i> 导出
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 主要图表区域 -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 id="main-chart-title"><i class="fas fa-chart-area"></i> 性能指标趋势</h5>
            </div>
            <div class="card-body">
                <canvas id="mainChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-pie-chart"></i> 分布统计</h5>
            </div>
            <div class="card-body">
                <canvas id="distributionChart" height="150"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 详细指标卡片 -->
<div class="row mt-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>实时吞吐量</h6>
                        <h3 id="current-throughput">0 Mbps</h3>
                        <small id="throughput-trend">
                            <i class="fas fa-arrow-up"></i> +0%
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tachometer-alt fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>平均延迟</h6>
                        <h3 id="current-latency">0 ms</h3>
                        <small id="latency-trend">
                            <i class="fas fa-arrow-down"></i> -0%
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>准入成功率</h6>
                        <h3 id="admission-rate">0%</h3>
                        <small id="admission-trend">
                            <i class="fas fa-arrow-up"></i> +0%
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6>QoE评分</h6>
                        <h3 id="qoe-score">0.0</h3>
                        <small id="qoe-trend">
                            <i class="fas fa-arrow-up"></i> +0%
                        </small>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-star fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 网络拓扑可视化 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-project-diagram"></i> 网络拓扑</h5>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div id="network-topology" style="height: 400px; background-color: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <div class="text-muted">
                            <i class="fas fa-satellite fa-3x mb-3"></i>
                            <p>网络拓扑可视化</p>
                            <small>显示卫星网络连接状态和数据流</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let mainChart, distributionChart;
let currentChartType = 'performance';
let updateInterval = 5000;
let chartUpdateTimer;

// 模拟数据
let chartData = {
    performance: {
        labels: [],
        throughput: [],
        latency: [],
        qoe: []
    },
    network: {
        labels: [],
        utilization: [],
        activeLinks: [],
        satellites: []
    },
    admission: {
        labels: [],
        accepted: [],
        rejected: [],
        degraded: []
    },
    positioning: {
        labels: [],
        accuracy: [],
        gdop: [],
        coverage: []
    }
};

// 初始化图表
function initCharts() {
    // 主图表
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    mainChart = new Chart(mainCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            animation: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // 分布图表
    const distCtx = document.getElementById('distributionChart').getContext('2d');
    distributionChart = new Chart(distCtx, {
        type: 'doughnut',
        data: {
            labels: ['接受', '拒绝', '降级'],
            datasets: [{
                data: [70, 20, 10],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

// 更改图表类型
function changeChartType() {
    const chartType = document.getElementById('chart-type').value;
    currentChartType = chartType;
    
    updateMainChart();
    updateChartTitle();
}

// 更新主图表
function updateMainChart() {
    const data = chartData[currentChartType];
    
    let datasets = [];
    let title = '';
    
    switch(currentChartType) {
        case 'performance':
            title = '性能指标趋势';
            datasets = [
                {
                    label: '吞吐量 (Mbps)',
                    data: data.throughput,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    yAxisID: 'y'
                },
                {
                    label: '延迟 (ms)',
                    data: data.latency,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    yAxisID: 'y1'
                }
            ];
            break;
            
        case 'network':
            title = '网络状态';
            datasets = [
                {
                    label: '网络利用率 (%)',
                    data: data.utilization,
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)'
                },
                {
                    label: '活跃链路',
                    data: data.activeLinks,
                    borderColor: 'rgb(255, 206, 86)',
                    backgroundColor: 'rgba(255, 206, 86, 0.2)'
                }
            ];
            break;
            
        case 'admission':
            title = '准入控制统计';
            datasets = [
                {
                    label: '接受请求',
                    data: data.accepted,
                    borderColor: 'rgb(40, 167, 69)',
                    backgroundColor: 'rgba(40, 167, 69, 0.2)'
                },
                {
                    label: '拒绝请求',
                    data: data.rejected,
                    borderColor: 'rgb(220, 53, 69)',
                    backgroundColor: 'rgba(220, 53, 69, 0.2)'
                }
            ];
            break;
            
        case 'positioning':
            title = '定位质量指标';
            datasets = [
                {
                    label: '定位精度',
                    data: data.accuracy,
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)'
                },
                {
                    label: 'GDOP',
                    data: data.gdop,
                    borderColor: 'rgb(255, 159, 64)',
                    backgroundColor: 'rgba(255, 159, 64, 0.2)'
                }
            ];
            break;
    }
    
    mainChart.data.labels = data.labels;
    mainChart.data.datasets = datasets;
    mainChart.update();
}

// 更新图表标题
function updateChartTitle() {
    const titles = {
        'performance': '性能指标趋势',
        'network': '网络状态',
        'admission': '准入控制统计',
        'positioning': '定位质量指标'
    };
    
    document.getElementById('main-chart-title').innerHTML = 
        `<i class="fas fa-chart-area"></i> ${titles[currentChartType]}`;
}

// 更改时间范围
function changeTimeRange() {
    const range = parseInt(document.getElementById('time-range').value);
    // 实现时间范围过滤逻辑
    console.log('时间范围改变:', range);
}

// 更改更新间隔
function changeUpdateInterval() {
    const interval = parseInt(document.getElementById('update-interval').value);
    updateInterval = interval;
    
    // 重新设置定时器
    if (chartUpdateTimer) {
        clearInterval(chartUpdateTimer);
    }
    startChartUpdates();
}

// 刷新图表
function refreshCharts() {
    generateMockData();
    updateMainChart();
    updateMetricCards();
}

// 导出数据
function exportData() {
    const data = {
        timestamp: new Date().toISOString(),
        chartType: currentChartType,
        data: chartData[currentChartType]
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `leo_simulation_data_${currentChartType}_${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

// 生成模拟数据
function generateMockData() {
    const now = new Date();
    const timeLabel = now.toLocaleTimeString();
    
    // 限制数据点数量
    Object.keys(chartData).forEach(type => {
        const data = chartData[type];
        if (data.labels.length > 50) {
            data.labels.shift();
            Object.keys(data).forEach(key => {
                if (key !== 'labels' && Array.isArray(data[key])) {
                    data[key].shift();
                }
            });
        }
        
        data.labels.push(timeLabel);
    });
    
    // 性能数据
    chartData.performance.throughput.push(Math.random() * 100 + 50);
    chartData.performance.latency.push(Math.random() * 50 + 20);
    chartData.performance.qoe.push(Math.random() * 0.4 + 0.6);
    
    // 网络数据
    chartData.network.utilization.push(Math.random() * 30 + 40);
    chartData.network.activeLinks.push(Math.floor(Math.random() * 500 + 1000));
    chartData.network.satellites.push(1584);
    
    // 准入控制数据
    chartData.admission.accepted.push(Math.floor(Math.random() * 20 + 30));
    chartData.admission.rejected.push(Math.floor(Math.random() * 10 + 5));
    chartData.admission.degraded.push(Math.floor(Math.random() * 5 + 2));
    
    // 定位数据
    chartData.positioning.accuracy.push(Math.random() * 0.3 + 0.7);
    chartData.positioning.gdop.push(Math.random() * 5 + 2);
    chartData.positioning.coverage.push(Math.random() * 0.1 + 0.85);
}

// 更新指标卡片
function updateMetricCards() {
    const perfData = chartData.performance;
    const admissionData = chartData.admission;
    
    if (perfData.throughput.length > 0) {
        const currentThroughput = perfData.throughput[perfData.throughput.length - 1];
        document.getElementById('current-throughput').textContent = 
            currentThroughput.toFixed(1) + ' Mbps';
    }
    
    if (perfData.latency.length > 0) {
        const currentLatency = perfData.latency[perfData.latency.length - 1];
        document.getElementById('current-latency').textContent = 
            currentLatency.toFixed(1) + ' ms';
    }
    
    if (admissionData.accepted.length > 0) {
        const total = admissionData.accepted[admissionData.accepted.length - 1] + 
                     admissionData.rejected[admissionData.rejected.length - 1];
        const rate = total > 0 ? (admissionData.accepted[admissionData.accepted.length - 1] / total * 100) : 0;
        document.getElementById('admission-rate').textContent = rate.toFixed(1) + '%';
    }
    
    if (perfData.qoe.length > 0) {
        const currentQoe = perfData.qoe[perfData.qoe.length - 1];
        document.getElementById('qoe-score').textContent = currentQoe.toFixed(2);
    }
}

// 开始图表更新
function startChartUpdates() {
    chartUpdateTimer = setInterval(() => {
        generateMockData();
        updateMainChart();
        updateMetricCards();
    }, updateInterval);
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    generateMockData();
    updateMainChart();
    updateMetricCards();
    startChartUpdates();
    
    // WebSocket事件监听
    if (typeof socket !== 'undefined') {
        socket.on('simulation_update', function(data) {
            // 使用真实数据更新图表
            updateRealTimeData(data);
        });
    }
});

// 使用真实数据更新
function updateRealTimeData(data) {
    const timeLabel = new Date().toLocaleTimeString();
    
    // 更新性能数据
    if (data.performance_metrics) {
        const metrics = data.performance_metrics;
        
        chartData.performance.labels.push(timeLabel);
        chartData.performance.throughput.push(metrics.throughput || 0);
        chartData.performance.latency.push(metrics.latency || 0);
        chartData.performance.qoe.push(metrics.qoe_score || 0);
        
        // 限制数据点数量
        if (chartData.performance.labels.length > 50) {
            chartData.performance.labels.shift();
            chartData.performance.throughput.shift();
            chartData.performance.latency.shift();
            chartData.performance.qoe.shift();
        }
    }
    
    updateMainChart();
    updateMetricCards();
}
</script>
{% endblock %}
