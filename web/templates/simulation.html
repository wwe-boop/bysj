{% extends "base.html" %}

{% block title %}仿真控制 - LEO卫星网络仿真系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-play"></i> 仿真控制</h2>
        <hr>
    </div>
</div>

<div class="row">
    <!-- 仿真控制面板 -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-cogs"></i> 控制面板</h5>
            </div>
            <div class="card-body">
                <!-- 场景选择 -->
                <div class="mb-3">
                    <label for="scenario-select" class="form-label">选择仿真场景</label>
                    <select class="form-select" id="scenario-select">
                        <option value="">加载中...</option>
                    </select>
                </div>
                
                <!-- 场景信息 -->
                <div class="mb-3" id="scenario-info" style="display: none;">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title" id="scenario-name"></h6>
                            <p class="card-text small" id="scenario-description"></p>
                            <div class="row small">
                                <div class="col-6">
                                    <strong>持续时间:</strong><br>
                                    <span id="scenario-duration"></span>
                                </div>
                                <div class="col-6">
                                    <strong>流量模式:</strong><br>
                                    <span id="scenario-pattern"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 控制按钮 -->
                <div class="d-grid gap-2">
                    <button class="btn btn-success" id="start-btn" onclick="startSimulation()">
                        <i class="fas fa-play"></i> 启动仿真
                    </button>
                    <button class="btn btn-danger" id="stop-btn" onclick="stopSimulation()" disabled>
                        <i class="fas fa-stop"></i> 停止仿真
                    </button>
                </div>
                
                <!-- 仿真状态 -->
                <div class="mt-3">
                    <div class="card">
                        <div class="card-body">
                            <h6>仿真状态</h6>
                            <div class="d-flex justify-content-between align-items-center">
                                <span>状态:</span>
                                <span class="badge bg-secondary" id="sim-status">未运行</span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span>进度:</span>
                                <span id="sim-progress">0%</span>
                            </div>
                            <div class="progress mt-2">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="progress-bar"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 实时监控 -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-area"></i> 实时监控</h5>
            </div>
            <div class="card-body">
                <!-- 关键指标 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-primary" id="current-time">0s</h4>
                            <small class="text-muted">仿真时间</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-success" id="total-requests">0</h4>
                            <small class="text-muted">总请求</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-info" id="active-users">0</h4>
                            <small class="text-muted">活跃用户</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h4 class="text-warning" id="qoe-score">0.0</h4>
                            <small class="text-muted">QoE评分</small>
                        </div>
                    </div>
                </div>
                
                <!-- 实时图表 -->
                <canvas id="realTimeChart" height="100"></canvas>
            </div>
        </div>
        
        <!-- 事件日志 -->
        <div class="card mt-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list-alt"></i> 事件日志</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearEventLog()">
                    <i class="fas fa-trash"></i> 清空
                </button>
            </div>
            <div class="card-body">
                <div id="event-log" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <div class="text-muted">等待仿真事件...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let realTimeChart;
let chartData = {
    labels: [],
    throughput: [],
    latency: [],
    users: []
};

// 初始化实时图表
function initRealTimeChart() {
    const ctx = document.getElementById('realTimeChart').getContext('2d');
    realTimeChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '吞吐量 (Mbps)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                yAxisID: 'y'
            }, {
                label: '延迟 (ms)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                yAxisID: 'y1'
            }, {
                label: '活跃用户',
                data: [],
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                yAxisID: 'y2'
            }]
        },
        options: {
            responsive: true,
            animation: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '时间'
                    }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '吞吐量 (Mbps)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '延迟 (ms)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    }
                },
                y2: {
                    type: 'linear',
                    display: false,
                    position: 'right'
                }
            }
        }
    });
}

// 加载场景列表
function loadScenarios() {
    fetch('/api/scenarios')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('scenario-select');
                select.innerHTML = '<option value="">请选择场景</option>';
                
                data.scenarios.forEach(scenario => {
                    const option = document.createElement('option');
                    option.value = scenario.name;
                    option.textContent = `${scenario.name} - ${scenario.description}`;
                    select.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('加载场景失败:', error);
            addEventLog('加载场景失败: ' + error.message, 'error');
        });
}

// 场景选择变化
function onScenarioChange() {
    const scenarioName = document.getElementById('scenario-select').value;
    if (!scenarioName) {
        document.getElementById('scenario-info').style.display = 'none';
        return;
    }
    
    fetch(`/api/scenarios/${scenarioName}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const scenario = data.scenario;
                document.getElementById('scenario-name').textContent = scenario.name;
                document.getElementById('scenario-description').textContent = scenario.description;
                document.getElementById('scenario-duration').textContent = scenario.duration_minutes + ' 分钟';
                document.getElementById('scenario-pattern').textContent = scenario.traffic_pattern;
                document.getElementById('scenario-info').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('获取场景详情失败:', error);
            addEventLog('获取场景详情失败: ' + error.message, 'error');
        });
}

// 启动仿真
function startSimulation() {
    const scenarioName = document.getElementById('scenario-select').value;
    if (!scenarioName) {
        alert('请先选择一个仿真场景');
        return;
    }
    
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 启动中...';
    
    fetch('/api/simulation/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            scenario: scenarioName
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addEventLog('仿真启动成功: ' + scenarioName, 'success');
            updateSimulationStatus('running');
            stopBtn.disabled = false;
        } else {
            addEventLog('仿真启动失败: ' + data.error, 'error');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> 启动仿真';
        }
    })
    .catch(error => {
        console.error('启动仿真失败:', error);
        addEventLog('启动仿真失败: ' + error.message, 'error');
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="fas fa-play"></i> 启动仿真';
    });
}

// 停止仿真
function stopSimulation() {
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    
    stopBtn.disabled = true;
    stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 停止中...';
    
    fetch('/api/simulation/stop', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addEventLog('仿真已停止', 'warning');
            updateSimulationStatus('stopped');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> 启动仿真';
        } else {
            addEventLog('停止仿真失败: ' + data.error, 'error');
            stopBtn.disabled = false;
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> 停止仿真';
        }
    })
    .catch(error => {
        console.error('停止仿真失败:', error);
        addEventLog('停止仿真失败: ' + error.message, 'error');
        stopBtn.disabled = false;
        stopBtn.innerHTML = '<i class="fas fa-stop"></i> 停止仿真';
    });
}

// 更新仿真状态
function updateSimulationStatus(status) {
    const statusElement = document.getElementById('sim-status');
    
    if (status === 'running') {
        statusElement.textContent = '运行中';
        statusElement.className = 'badge bg-success';
    } else {
        statusElement.textContent = '未运行';
        statusElement.className = 'badge bg-secondary';
        
        // 重置进度
        document.getElementById('sim-progress').textContent = '0%';
        document.getElementById('progress-bar').style.width = '0%';
    }
}

// 更新实时数据
function updateRealTimeData(data) {
    // 更新指标显示
    document.getElementById('current-time').textContent = Math.round(data.current_time) + 's';
    document.getElementById('active-users').textContent = data.active_users || 0;
    
    if (data.performance_metrics) {
        document.getElementById('qoe-score').textContent = 
            (data.performance_metrics.qoe_score || 0).toFixed(2);
    }
    
    // 更新进度
    const progress = data.progress || 0;
    document.getElementById('sim-progress').textContent = Math.round(progress) + '%';
    document.getElementById('progress-bar').style.width = progress + '%';
    
    // 更新图表
    const timeLabel = Math.round(data.current_time) + 's';
    
    if (chartData.labels.length > 50) {
        chartData.labels.shift();
        chartData.throughput.shift();
        chartData.latency.shift();
        chartData.users.shift();
    }
    
    chartData.labels.push(timeLabel);
    chartData.throughput.push(data.performance_metrics?.throughput || 0);
    chartData.latency.push(data.performance_metrics?.latency || 0);
    chartData.users.push(data.active_users || 0);
    
    realTimeChart.data.labels = chartData.labels;
    realTimeChart.data.datasets[0].data = chartData.throughput;
    realTimeChart.data.datasets[1].data = chartData.latency;
    realTimeChart.data.datasets[2].data = chartData.users;
    realTimeChart.update('none');
}

// 添加事件日志
function addEventLog(message, type = 'info') {
    const logContainer = document.getElementById('event-log');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    
    let iconClass = 'fas fa-info-circle';
    let textClass = 'text-info';
    
    if (type === 'success') {
        iconClass = 'fas fa-check-circle';
        textClass = 'text-success';
    } else if (type === 'warning') {
        iconClass = 'fas fa-exclamation-triangle';
        textClass = 'text-warning';
    } else if (type === 'error') {
        iconClass = 'fas fa-times-circle';
        textClass = 'text-danger';
    }
    
    logEntry.innerHTML = `
        <div class="d-flex align-items-center mb-1">
            <i class="${iconClass} ${textClass} me-2"></i>
            <small class="text-muted me-2">${timestamp}</small>
            <span>${message}</span>
        </div>
    `;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// 清空事件日志
function clearEventLog() {
    document.getElementById('event-log').innerHTML = 
        '<div class="text-muted">事件日志已清空</div>';
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    initRealTimeChart();
    loadScenarios();
    
    // 绑定场景选择事件
    document.getElementById('scenario-select').addEventListener('change', onScenarioChange);
    
    // WebSocket事件监听
    if (typeof socket !== 'undefined') {
        socket.on('simulation_update', function(data) {
            updateRealTimeData(data);
        });
        
        socket.on('simulation_started', function(data) {
            addEventLog(`仿真已启动: ${data.scenario}`, 'success');
            updateSimulationStatus('running');
        });
        
        socket.on('simulation_completed', function(data) {
            addEventLog(`仿真已完成`, 'success');
            updateSimulationStatus('stopped');
            
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> 启动仿真';
            stopBtn.disabled = true;
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> 停止仿真';
        });
        
        socket.on('simulation_error', function(data) {
            addEventLog(`仿真错误: ${data.error}`, 'error');
            updateSimulationStatus('stopped');
        });
    }
});
</script>
{% endblock %}
