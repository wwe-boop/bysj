{% extends "base.html" %}

{% block title %}仪表板 - LEO卫星网络仿真系统{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-tachometer-alt"></i> 系统仪表板</h2>
        <hr>
    </div>
</div>

<!-- 关键指标卡片 -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">总请求数</h6>
                        <h3 id="total-requests">0</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">接受率</h6>
                        <h3 id="acceptance-rate">0%</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">平均吞吐量</h6>
                        <h3 id="avg-throughput">0 Mbps</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-tachometer-alt fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h6 class="card-title">平均延迟</h6>
                        <h3 id="avg-latency">0 ms</h3>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <!-- 性能趋势图 -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> 性能趋势</h5>
            </div>
            <div class="card-body">
                <canvas id="performanceChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- QoE评分 -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-star"></i> QoE评分</h5>
            </div>
            <div class="card-body text-center">
                <canvas id="qoeChart" width="200" height="200"></canvas>
                <h4 class="mt-3" id="qoe-score">0.0</h4>
                <p class="text-muted">用户体验质量</p>
            </div>
        </div>
    </div>
</div>

<!-- 系统状态 -->
<div class="row mt-4">
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-satellite"></i> 卫星网络状态</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 id="active-satellites">1584</h4>
                            <p class="text-muted">活跃卫星</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 id="active-links">0</h4>
                            <p class="text-muted">活跃链路</p>
                        </div>
                    </div>
                </div>
                <div class="progress mt-3">
                    <div class="progress-bar" role="progressbar" style="width: 0%" id="network-utilization">
                        <span id="utilization-text">0%</span>
                    </div>
                </div>
                <small class="text-muted">网络利用率</small>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> 用户活动</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6">
                        <div class="text-center">
                            <h4 id="active-users">0</h4>
                            <p class="text-muted">活跃用户</p>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-center">
                            <h4 id="active-flows">0</h4>
                            <p class="text-muted">活跃流</p>
                        </div>
                    </div>
                </div>
                <canvas id="userActivityChart" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- 实时日志 -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-list"></i> 实时日志</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> 清空
                </button>
            </div>
            <div class="card-body">
                <div id="log-container" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                    <div class="text-muted">等待日志数据...</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let performanceChart, qoeChart, userActivityChart;
let performanceData = {
    labels: [],
    throughput: [],
    latency: [],
    qoe: []
};

// 初始化图表
function initCharts() {
    // 性能趋势图
    const perfCtx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(perfCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: '吞吐量 (Mbps)',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                yAxisID: 'y'
            }, {
                label: '延迟 (ms)',
                data: [],
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: '吞吐量 (Mbps)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: '延迟 (ms)'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            }
        }
    });

    // QoE评分图
    const qoeCtx = document.getElementById('qoeChart').getContext('2d');
    qoeChart = new Chart(qoeCtx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [0, 1],
                backgroundColor: ['#28a745', '#e9ecef'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: false,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });

    // 用户活动图
    const userCtx = document.getElementById('userActivityChart').getContext('2d');
    userActivityChart = new Chart(userCtx, {
        type: 'bar',
        data: {
            labels: ['接受', '拒绝', '降级', '延迟'],
            datasets: [{
                data: [0, 0, 0, 0],
                backgroundColor: ['#28a745', '#dc3545', '#ffc107', '#17a2b8']
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// 更新仪表板数据
function updateDashboard() {
    // 获取仿真状态
    fetch('/api/simulation/status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.simulation_running) {
                updateMetrics(data);
            }
        })
        .catch(error => console.error('获取仿真状态失败:', error));

    // 获取性能指标
    fetch('/api/performance/metrics')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updatePerformanceCharts(data.metrics);
            }
        })
        .catch(error => console.error('获取性能指标失败:', error));
}

// 更新指标
function updateMetrics(data) {
    document.getElementById('total-requests').textContent = data.total_requests || 0;
    document.getElementById('active-users').textContent = data.active_users || 0;
    
    const progress = data.progress || 0;
    document.getElementById('network-utilization').style.width = progress + '%';
    document.getElementById('utilization-text').textContent = Math.round(progress) + '%';
}

// 更新性能图表
function updatePerformanceCharts(metrics) {
    const now = new Date().toLocaleTimeString();
    
    // 更新卡片数据
    document.getElementById('avg-throughput').textContent = 
        (metrics.throughput || 0).toFixed(1) + ' Mbps';
    document.getElementById('avg-latency').textContent = 
        (metrics.latency || 0).toFixed(1) + ' ms';
    
    // 更新QoE评分
    const qoeScore = metrics.qoe_score || 0;
    document.getElementById('qoe-score').textContent = qoeScore.toFixed(2);
    qoeChart.data.datasets[0].data = [qoeScore, 1 - qoeScore];
    qoeChart.update();
    
    // 更新性能趋势图
    if (performanceData.labels.length > 20) {
        performanceData.labels.shift();
        performanceData.throughput.shift();
        performanceData.latency.shift();
    }
    
    performanceData.labels.push(now);
    performanceData.throughput.push(metrics.throughput || 0);
    performanceData.latency.push(metrics.latency || 0);
    
    performanceChart.data.labels = performanceData.labels;
    performanceChart.data.datasets[0].data = performanceData.throughput;
    performanceChart.data.datasets[1].data = performanceData.latency;
    performanceChart.update();
}

// 添加日志
function addLog(message, type = 'info') {
    const logContainer = document.getElementById('log-container');
    const timestamp = new Date().toLocaleTimeString();
    const logEntry = document.createElement('div');
    
    let iconClass = 'fas fa-info-circle';
    let textClass = 'text-info';
    
    if (type === 'success') {
        iconClass = 'fas fa-check-circle';
        textClass = 'text-success';
    } else if (type === 'warning') {
        iconClass = 'fas fa-exclamation-triangle';
        textClass = 'text-warning';
    } else if (type === 'error') {
        iconClass = 'fas fa-times-circle';
        textClass = 'text-danger';
    }
    
    logEntry.innerHTML = `
        <div class="d-flex align-items-center mb-1">
            <i class="${iconClass} ${textClass} me-2"></i>
            <small class="text-muted me-2">${timestamp}</small>
            <span>${message}</span>
        </div>
    `;
    
    logContainer.appendChild(logEntry);
    logContainer.scrollTop = logContainer.scrollHeight;
}

// 清空日志
function clearLogs() {
    document.getElementById('log-container').innerHTML = 
        '<div class="text-muted">日志已清空</div>';
}

// 页面加载时初始化
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    updateDashboard();
    
    // 每5秒更新一次数据
    setInterval(updateDashboard, 5000);
    
    // WebSocket连接
    if (typeof socket !== 'undefined') {
        socket.on('simulation_update', function(data) {
            addLog(`仿真更新: 时间=${data.current_time}s, 活跃用户=${data.active_users}`, 'info');
            updateMetrics(data);
            updatePerformanceCharts(data.performance_metrics);
        });
        
        socket.on('simulation_started', function(data) {
            addLog(`仿真已启动: ${data.scenario}`, 'success');
        });
        
        socket.on('simulation_completed', function(data) {
            addLog(`仿真已完成: 总请求=${data.result.total_requests}`, 'success');
        });
        
        socket.on('simulation_error', function(data) {
            addLog(`仿真错误: ${data.error}`, 'error');
        });
    }
});
</script>
{% endblock %}
